workflows:
  notarization_with_cli_fetched signing:
    name: Notarization with cli fetched signing
    instance_type: mac_pro
    environment:
      vars:
        # Private key needed to install a created without Codemagic certificate
        CERTIFICATE_PRIVATE_KEY: Encrypted(Z0FBQUFBQmdiOXBBdlNmRC1wT0JjNm5JbWtwcnlCTHRuTW91WXpFbFBvUVNYUEk0VnlCdW05emhRQXJvNGRnM0NMazlDTm1Sd2hYYjBEamg2MzJGMWg4clNDWnAzQjVrNW4tb2dESkw0eTFoVktUUHFEZWFhcFJhQ04tQ3R2dU80UlVVa0tFVzlxVkNielR6U2txY2hoaDhoSDZXV0ViZVR4Z2t2RFZWSUlTa0hIMDhxMUgtSFh0TWYxT0tyNVVyWnpLWjFaR180Y1ZIRGxwS1VkNnB5YmxSanM1Mnc3QURob3E1MEt4emJKMDZFYVJnVkxxTThMNGdqcUhtQWtGcmRnS2xXYk9xRTk2Y0hjS0ktdXZ6SXJPT3ktWjRVdVh0d3RxQlpXamplTzU1QUt4V3o4U251ZVhBbnFBN0U1MkJyZ0E3djhCS3lnZjF0bVp6ZERkTmkyQjJuUWwtYVFjNFRjVjh4cUp2MG5NWWxNaUFXRFhXZnRQTG5pczc1NkVBWFRWNmlWY3ltZ1pXdENsN1NzaHpaWUE0YXpLVDlBNTQ1OGFaa3FaQVBGM1pPWkhEWE1fd0MyaEIwbHBXSUN6Sm5xUFBPTWptal95ZnF2UWhEb3QwSDNnV2NUMWpKSlJEUmxrMmprZFhmNEFoRURVa1l2dHF3cVppVklkR25iQ1U3RUg3bjBGMzgtbENueXR6T3oybjFTcm9JaGxsQ0R4NFRnRlJMZjZGdHpEUE1odUhmVTlCQnpYOEVTbHpsY3h4U3ZhenlIZmg4MVVLOHdLTFYyR3lJZzlhWU1QVDJ5U291R0pkbW5sYnp1U19iaENTby1FSmtkNHpCd0p2aGJJcG1OeUxrQ0RGd2gwT0FicjE1TVNoVnFvdTlrZHdFc19IbWJEYjlaQ0tjSmVMT2NBdzZGX1VEVTdlLW1LNzlZelc1d3lWRHpMMDlCV2QtbkpYZ3lBbmJqSjdVYnNDRnhDNVNVSVZpelg3bk5xREI3S0hLVXZrY0VJMk9KVW1BQ1Z2bVVHM0toNzNDRlUyYlkwV3R6ZHdBLUlMeXZYY0tFSExfZFVDSXVOLWljN2s2TGtTellZZW90Nk5JYUxLTm5LMVNfcTBtZWttT2N2eWFwZEtJaUpZZ1hhUHI3Vlo0anRFd1FyZnZVX0VWdXRkdHJMbjRvQUNMTldKX2N5dlA4THlWRGZRd3lPdzZqNktsdEVNMlBHUi1Sc2Vfd3hPV1V1VWQ2cGp1c1hWVzJGSDQ1aDY2UEJ4Wm5ic3gxdWhXRFM5dk15b3NweFJpUTRxaXhGRlBLaHZkMnR0N0c4dGpEOXZaSmdrUF9JTlBqWDZFRHVvQ2xKZkZoNml6Z2ptenNjTzlrVERNNTRYUGUyQ3dQVEZkcVpOXzFVUW1ZQTBvZC1vbmtrRVUxOXlKU051bi1lWHA2NUZzU0d1ZVo1bUlmSFFZX1lzOFpZTHVZblZYOVA3VU1NdERIMC1UeTB2UGNKWVVRMFJhMUprMUVGT1RSUXJCNG11NWJkVU1NaHJ0aW9ZdENQNERLTFFuLWxjYlpUaXNuOFl3V0c5bnh6d2JhUkxwX2ItWFVya0Z1SDdpS05wcVpHWW9kSEk5aXRKNEowaUQzbXp4d3F3d2NDUjJxR0JfU28tX3h6UmN2MHB3S0hfV2JLakJFTGZfd0VZQlptSGtBNHFiNzNTdVhWcWhxb01idG56VlNaOGtrVGV6VmxXSlAwODlqTm90RzV6UkkzYS1PYW41NEs0cWVqMWd3TFdyMWlzXzF6bEdjMjJ4YmlubjlfT3JNUHZDR3RYQjlVYzZpcVBQdVFyb0JSeV9FcXNoRHdScXNoVE5sb1d6emprYmx3QjBQc0d4Q2tEM3k2Tk1tOXpRT0p6TUZUYWhYZmhIcjg4ZkxXXzRzb202MjhYZ3VReGhzaE81SVgyVXhCTmhkc2lVTlN6XzQ1RnVVdkdQclZUODRzQjdlLVRsdjRLYjBDYUFudWVXdlZ0SUdBR1piY2RackJaLWx2dlpUQS1Dc29JOENNWHdWdzdFT21nLWpVd3JmRkVmWEY3S3JfQkxkQV9OTU81VndUR2FSS3ZBdVFaSnBiQ3hhQ05yZWZhWTRDdmR1dlJSTTR6dHRGSW5qNWZ1RWw2alNJSEZEWE1aWFJDTkJqZlNEbk9mampYb0Z5TW5QQUZxZHY5NG1xR0RMTVJXaE9NNTAtSm12T0V5VW41dVNLajRtY1g4SUVsWThEZlBoalgtRXBHbUhGajJaOFFsZV9pbmFHWGkyVVNZTzNpRFRrM1A0RTBtUnJ3dzRXcG9pLTFXdlhHZVllUmpwek55TTBoUGl0N1RvQUxyQVhIRXRZcWJmRG5VQ3VTNGZIUnB6TTNGellHN2tjN2RDUkhBTWduUHRMWWlNX2M4aktqaW13Qk1iQ0lIQml5VmdFbS1BdXdPZmJRY18ySUhPR1BGMGFXbUZJZGlmOWtweDJLTUctd0FIemd2SDFxSlZ3TWtwZ2RXQTh3UFUwVk42alVUQ1J0VUVKdTlfNlJyR2llOXZUN3RjNjRDdTBsMENxTUNJd2p2NXd1WDhzOXJ2ajNzem9UeUtiZXBYejhKbFRZSGNzN21zcHRaNm53VGN5NXVGbDVZc3dpdFZrVDRLUi1zOHNlVzdFWnBtVG9XZWREMGhSUVFPU1Q0NmxBMEtNeDFXTkxpdXBBMmw0ODVKU1VMQmNUMkk4RHBOWDdRVDJrZ0RSaE1pRHJ2Vno5UjJUX2Y3a1ZGQzBKQkNIakd3VXRaeXYyNVgzTjUxc05tcEc2YlJsU1JVaVh2TWNoX3k5b0lObGVMU2ktb00yaU1mdEkyQ01nbTBJVF9vOFV2WWl1Z011dGtSYWFoWHN0WXZEdG95MlZyc0s5ZWpCd1J5QWhwWUZFVTdzTmp4cTZWY0UyTndVWEQzZEpLXzc5aFZYUmY1RWxuemloOEFsbDMyYk1jcUFvbC12b0NVclpJVTZ0X2JjU3AtRk5TVmJrczNzeDlMTTFyNFg0a251WU03UTc0TDFIRTl2YVhmQ0RmOFJNRk5fM3JERzQxTzZDYjY3eDJXdW0tTzNr)

        # App Store Connect credentials required to use app-store-connect cli tool
        APP_STORE_CONNECT_KEY_IDENTIFIER: Encrypted(Z0FBQUFBQmdic05WMlNkXzFkUWFySmJIOW9CdkprSVNGZ3JrUTVTcnpYUzZ0TTBVa2U0TzdMcndGNHFIOC1ZUFZFWldWTjJ2Q1NpTl82WjBCMU1nLXRxSTh1NTRSNkxwNmc9PQ==)
        APP_STORE_CONNECT_ISSUER_ID: Encrypted(Z0FBQUFBQmdic05IWl9YWXdXQmxrRXc4ckViaWNrWWpnaEdHYmRCUWRDc1hWdmdHMWk2WjdWOHBRSlo1LWRBLUN4R3k5aU9QM1ZPdTVMVDNWc3JHVVJ0MTUxQTdBbHYyTnNId0tMY2VkZWZGY0paWEE0TlJCRGNUaU5GMkt6WW1OSHRoM3pTWmdUU0k=)
        APP_STORE_CONNECT_PRIVATE_KEY: Encrypted(Z0FBQUFBQmdic016b3VKc2NJRkxwTnloM3dNSFdVam4xTzRUY2F1R250d3kyTzJtendGa0I2Ti0wZ1RTb0JKb2QwdUhzQzdfcG9oblYxMDJaNmFTdDBsc2lPREtFSzQyZDFKOFc1VU9JakY2OFg2eWxkd0tBSjVaQlA3SU4tVkJ6Q1hKV3Q0SmYyY0QxOWhkS3g0RXU1UFlGUThGUnd6VEhOTUJKd1lRcS1rTmZrVWc2SU1WeTNHMGV1dUN4M1k0SFlfVVVfWXlwaW9yNmdFMldJdW1aSmdFa3ByaDBndWhTcERka1g3am9pVWNEaUd2N1duN2gtRDZYUEhNbmwwWmVuSVhja3dEWDJGOVFPeVRfWTlKN21iSUVpeGgtdWpWZGdYRDU5Q2xqR2M1YlU1TTVTZG9RN05paE5kd1NEc01KeUtPcTBFSS1OUjQ3cVQwY1E3QW10ZE12VkhPbFd1M1h6WS0zUEhEeU0teTRERFU2b2ZOeUN0YWRBdDVjczRmZUsyN2hMNXlqVDRZaWNGSnZEaUgweHJTTFR6b3EyemtQd0ttR3lpN1ZCREx5NmhjZDI2Sl9zQT0=)
    scripts:
      - name: Set signing
        script: |
          keychain initialize
          app-store-connect list-certificates --type DEVELOPER_ID_APPLICATION --save   # for distribution outside of Mac App Store an app should be signed with Developer ID certificate
          keychain add-certificates
      - name: Build
        script: |
          flutter config --enable-macos-desktop
          flutter build macos --release --build-number=$BUILD_NUMBER
      - name: Notarize
        script: |
          set -ex
          cd build/macos/Build/Products/Release
          APP_NAME=$(find . -name "*.app")

          ditto -c -k --keepParent "$APP_NAME" "application.zip"                         # altool can only accept an archive, disk image or package
          REQUEST_UUID=$(
            xcrun altool --notarize-app -t osx -f application.zip --primary-bundle-id io.codemagic.macosDesktop -u $APPLE_ID -p $APP_SPECIFIC_PASSWORD --output-format json | \
            jq '."notarization-upload".RequestUUID' | xargs)
          REQUEST_STATUS=$(xcrun altool --notarization-info $REQUEST_UUID -u $APPLE_ID -p $APP_SPECIFIC_PASSWORD --output-format json | jq '."notarization-info".Status' | xargs)
          while [ "$REQUEST_STATUS" == "in progress" ]; do
            sleep 120
            REQUEST_STATUS=$(xcrun altool --notarization-info $REQUEST_UUID -u $APPLE_ID -p $APP_SPECIFIC_PASSWORD --output-format json | jq '."notarization-info".Status' | xargs)
          done

          if [ "$REQUEST_STATUS" == "success" ]; then
            ditto -xk application.zip . && rm -rf application.zip
            xcrun stapler staple "$APP_NAME"
            spctl -a -vvvv "$APP_NAME"                                                   # ensure that the application is signed
            ditto -c -k --keepParent "$APP_NAME" "application.zip"                       # need to archive it with ditto otherwise codemagic's zip archive will brake the signature
          fi
    artifacts:
      - build/macos/Build/Products/Release/*.zip
  notarization_with_supplied_certificate:
    name: notarize
    instance_type: mac_pro
    environment:
      vars:
        # Developer ID certificate required to distribute application outside of Mac App Store
        CERTIFICATE: Encrypted(Z0FBQUFBQmdiOFg1aFlHbHRGVVUtWWMwRklWUFlJczd4S3VfaXQxdmtoclg4QkZ3bEN2TVl1VGRoUnB0aGxiOEhGcXdxQTFudVprVldNOWY5ZDUwSEtyYk5uZWs0QmhRenA4MkpBSHo0VkJvZ3lOY254SElKd3I2Y0xuZFhDc2hDT0hoOEt5RGFrSTRUU01MNU1YSWpBMnJZbXFGT1ozTEtVZmY0aVd0SXMtQS12Z3FtQ2Rsa3dGN19yY0hFbjAxeGVRamJnSDg2V2p1QW9LTG9qWmdTOHhPOF93ZHZieHREbTBYMV9JS3JSRDctbXRRZS1rc2RZSHNlSkJJLWVkbnFDUE0taG0wY29XcUZLNnlZXzdLemtnS2l4c0YxczZBM0FrbWYwMGl0QzJsUGdTRFNYX3hhMENJVDdCeVB4ZzRpcHNPdzZJMC1XdHFKZ3JPYnFVZVp6N25Zc1lMcmdzcURqbEItU1BMUHFQSDNCdU11MDI1aV9qX3NJSlZHSzVoRkw2NGEwTTMwSTRzeEh4NlNZeHpYMnRPa0RXa3hPRHA5VkdKb3V1eFlXSk1LSk5oVlRnOURkNWVRUE9uVU1MeVVJVlM3ZGNqMENBY1VkWDlsZXItLThtaGliNW9RbWdOLUZyYnV1T1N1YVlJRnU1aUVtQjJRR2Eta055ejhtSldTRHNaT3hTRDE4RUt1cWpmMEpfM21DWk9TbFV6UXBOazJKT3hXcHJJN2E0amlDaThJZGttdk5oLUJVSmlFSnF6LTFXZmo5ZFpTU3M1OE4zMExJSmQ5bk1GaFhhTVozS2V3YnZ3Sl9kclBXdWRtOHhDNXZCSXJhcHdfbzJtS3NDMmI1alJDa185OEVXUkdfaXVjTUg0VUJWejN1X1pzSEtHeUN2Uy13WHhrckhlNlpOUllXbmNfVVBFNy1SaHFQa21BWURWd0J6RHdkdnlvUHFDQ2NCTXFSM0lfcTFJZ3pfZVIxNFZQVERrODR2WXJXUWYxLUdkSm9DSnZVV185NUhrUGtXZGVCM0xLdldvc1dtUlFUUnRkUXVRNU1uSHlQUHdnOWJoV2JRRER0UTExdnJ6SXNIZ0FsZlR1WlRoSW53SS1DVGdhOTdUSUNYVmxTdzEwcDVmNS1IWWRfS0ctOVNUOVFYU1RJbVg0TzdabUlKTG01TzFwLXJwNkJXdHozS2ZpM3FYMmRtVWZDZTJoT3JpMWMyaUxka0xhRDROcTUzd25uSUVNU1R5d2NnVWQ1NzRuWVJwU2xId1ptamg2MXdMWWVtR1ZVeXlwQnFCVi1BUl9FYnNIRVBfOFMtejc3aFpGMU05S3RZdm1zeTBmOC1sWG5ObmRMSjJralJPc0U1TlBfQTEzUFNySUxTUEZDOGIwdmJycnhlYWxvNmZUVmJ6ODhaeU45aWVRelpYUVlYRlpxenhxNHJhTDRSVWdzN3FEV0pYMEhVcUZ3YjkzN21qNnFMZjZPYlpIdFhiU2lwN1lLMktaZ1dTWHhFN244QU9xYzR4X25KUUt3RlktRWFwaXpfdi04Nlk0Q29wc2ZKcG5IMnBhRjNMZ3VMdEhTRXFlemtzeTBIcEY5ZHgxQ245TUFiOHY0WHNzdXFFem9Nd2tJbTdqWXNVYnhWYjJadVItM3VlaC1DZUh3RWtPV3czcG5WcWFnaUhHbzJwNVRudUVnb3lfZm1hbUZLbGdsMndOWlAwcDNEam5zRVpoQTdOdHFlSi00dzJlRmR3aXlSMVNXVjROQmotV2gwb2tnSkZEODZFSi1wVEpGakRqX3VEX2owZVJzX01ZWTNPT3k0OGJnb0xPdXgzZ2h3UldfeEE3UXl6clprUDV1VDVVWW9ZZGxWeE8zUUhJYzl0Q0k2LXJ4eXg1UWYxWV9UV2RuMm9Na0F4YVoyUXExUTBYQkxnbXNUSTBsSmF5ZVlPbmU5LWcwdHlRbFhwZ01JNEo1Nndqd0UwVDFTMUJWaDJYMWtZb2hLcEJuQXVxc3pDVzNNVFFkNkc1RGRHT2lPUnNMOFZGNTM5N2NNcE9QRWtHUklUZHdMamtPZ3Z1eXN3dkpWZGlSZndrT1RodWdVUEE1WGNRaGlKSTdqX2lLUFRJRTUtUFdsaXRkUGNUbWItRzlkVjFneVhFNmI0dU9Jbl80RTUxV0t6MkMxQjE2OWJxR0ZOeVB4a1p5UHlxMHl1a2J5U08tVUJxN2x6eEdMbjk3NGJVRTNYUDRHNGpCVzRUSXNCRExBSGpfbGZWVjNZeGRMTm9NczhlM2NPQ3UyOG1oWmU4dXFYaFhhUEUza1VVcEw1VGc1NTVGcW4ySEstS3VobkNPWXRoX3o2c3dpZkpNWUY0R1BabHR6MExreFc2b0VnLUdTd0I0VFJ0THBtTGt6MklUZTVUOU1SV09rZ2lrWkxJaE53M1M5ajRnck83eEZRN2NhczNhcmxaVFltczN6RU1oMjRrQ0pYMGl1QlNDaTdpM3NEejFaV2V4akNycFRFbU80N1FXelhMbmVIUkhycjVMVVd4OUlWOTIxbS1qajZVOU1GSkU2TTlXUjcwbzVoeFBvX1BzTm9RMmtIRUFMZXNlc0RHcWs4bWgtWFA4eHpHNEZJRkgzSjlBZy02VTlQSUVLTmZ1cTI0bjhMZmhNZ2hfTFpZenhrWVVHdXNuelo4b1NkN3RjN1ZUNEVxdEVTN3FlQ1BfQklOUk11Rld2SmlIa1g1Vnh2amtRSWV6SU12Ri1JMlNQWTh6ZFJ6TUpXTnRzWGNtUGcwcldnNG9VSDM4Unp6eWd4SjlRNGpHNW1NWnJnRTV3TklxUWRnMk5BdFdYS0VqWXBuLVlYMVl3bDBMcFBhMFhxVEdVM3g2ZXlJcmZIdGM3Q21wZ0YzdzV4V1V5elpHdUFkZ3Brb2tUX2dWNElkZ2tIV0V5V2NqV1JrbTk4YjJOdnd2UlJYMHoycEs3aEpmX3RVd0w1elhDRUJYbGkzX0dqOFZ0M25zNzh4YVk1WmUwamlPVDRqc2dkRU9Iam9hazl4dFRfa2NoYTNhXzU4Zm55ZFVaYkxmTTRVYjFwOEREOHl2MHBPU0JxeFY3TjA1d3djcHM0aWxPd2gwSFpDZWJVc2NUT2ZpQUxhZl93NEl3QnhEOGVLeW5ZcWtGZGsxTmthYjVEbGRIQ3NoLTVROHZoaUJXUW1LVE1mX0Q2eHhYVkF5QWExakNCQnVuMDVtbEVtR3BURWEwaG1ZLXlHVTdNNFV0SDRZQ3VkTklFaVJDc2d0RjJCUkMxWTl6elM5MGxKMGd3ZkJ5b0VVWERIeGtpYTBkcW90QVRlZGpyNjZUdnZjMXBReTBwaWkzUHJaRWdfMVV3R1RCMGxCMzcyS0QyWW9jM19FRHB6bTF2cjk5VGdnT0NkSkMtX09BWmVwZ29RS192MEpPTVBlbEtKNWxtLVl6WUdOVUFUMTNaaTFHc2tmamtPQW9JS2VldzBlbU9aZ2VMLTJlNFBwM2JGbzJqM1VmRlRTLXBSSjBOYlRBeWRDUUkxOGt4Nmg5bktfcURtZ3k0X0ZEc0pOemwzQ0hzWHE4NkZCOTdVQUtmZjBDbVZZZGdRYjhBTWk3UDdvWTZiY0hYd1FqeFJBRlpCdmZiU1ltTDBzVkJSNm5vQld4UUxBR05QZkh1a1VJRWlvdzcyN2xNUVVUM3Nab3RBcDB1RjJXQ3QwU0p0QXRaN1BQbVNHMnUyUzFvaTNwc3hERzVIM3pkTW9XMWtpVnhtZnRRa0ZnSHBsNGtBV2s4c1JHeVpoWlp2dDk2UkZXRFd0TUl3d0NOSDl0bW5pcFVHZV90OEtEVGxSTk1Pb0dXQVZZZ0lIaGpvX1RIWDFtdzZwc2M1WWdwNHdOZ2sxMnU2Zk9uUjZrWVdlQXNkdENTNmVwdGJrR0VKUEo4ZWdvVVg2ZElzbUFIUHJIOWRyd3ZFMklSdTd1T3pwOWVwVUpiaFJUbG04WnZ2a0ROWDdGd0podVNrZ3Q2Rl9ZdTdxVl9mU2xJRkZCSmFRTXpQR2Jack1aTWVtdjgwOWVQZ1c0RmVZQnZ3aEF3SVF6U1RMSkktaGswejJKdGkzQS1XUi1uX1ozcGFjRl81VC1oRi1yZVVPc1NpTW42T0FhOEE1eFJqR0w2WXY4LWZmMU9RTWpNTFdpeEM1cnpjN3VnalVBdG4xUmw5YUs1ZXpxYURvOG9vYTZEWG5oQmVUMVE4OW5GZThkWDJXMzdUa056NFBoQ1BuY0ZnMmlOSzZ2S1QybWRsMVhWQ1RHZ0hnRXYwZk00NGRHZ3ZfeU1zUTJ5QVhpVlFvblV4cXVJY3VnaXBMSnlzamhrRkp6Y2pya254LXFVc3lydU1LMWVkNktjRTE2eksxT1U3SHk1MkYteHR1SVZnS05WTHVpbUUwVmxySDYxRWJpVDctQTRhdWtSQU0wVGQ2TUwtWmFVMnYtbWw2ZFE0c2pYQlQ2MnhUY2R4ZE5pYUFnMWRzZkZwVzVHdGYyU3Z0SlljM0xhRk1UVDNZUk9nM3dzWi04ZjZhN1oyemx2ZERCOERFNFlzVi1FdmtOeURXdzdXblBBaGhNN0gtQTVUZWVMM09XS2J2bnhnZTMtN0x6UUlrREVyYUZyd1V3Wk83RlZaQm9SSG9tQkstTlpsbnFpcHFma3lSeWhkeDFNbV9HQW5CS3ZWdkp3aVR1LXNyd2RRRlN2RUlhODdnWjFtckdFbG9jYUtPSWxrajZDT2Rsa0RNekg4WkJEUG5aNTExbkRBVUk2aVpYbkJWMW1fV0ZUS1RHUk11UjA4V2dqUU01OUdKUERhMEhaWEdnV3RES3R6aENLTXppRG93MWdOR3lEXzFPdl9kekVkTzduS0s3RWQ0MFFxZHFNbWs4WU5LMkV5SlhnVFNlYW56TGhseDFacGxvMXNPeS02WllWbW9zWDlkRmtZX2Qta2dldTlTTS1CMjZtaEdlOGhHcGRjX3NZZkt5UnlESGJzakFCaGNTMkpoTW5HaFZhbG9wbjc1VndIM3ZVeDVZR2Mta1EteFJ3ZGloQnpqSGlFVnJUTkh2RVFXQU1VUnEyaTk0UGI1MTd0bWowN04zdmNTXzBhNE4tQnFsSDkxVXlVZFBWWWdocFctWTAyZTFUeEZWNkFRZ1loT2d2Ynk2VGZZV0liUjhxbWZDYnh5RDZ1QzFNYUpFdXBDY1pNY2pQN1FaUXRBcDF5VE5RZ2xjUlpXZWpxekxRbWg1elZxaHV0dkZScElqS3RkRnJYYW96bEVLcGt5RkJ6b2JVSTVERTdLRV9vZ0FJZmM3RVM2YnoxdzN4dUhKaVpNdFJHaFA5eTZ3QlpKZ2N5cTd4RFBtVGo3RV9peDNNSGZXSFdnMWhPSkVyTE1CN0hVcGJYM1ZTNXZCbzUtT1RNcXdsTTJXQjI2c3Q0bGZpRXZjZldhY3Q4MEtEcTltVTYxcWlmV01qYUN4Z2pQbGw5UFZ1aks0X19RY2lGdndsRU1UakM1cm1TeW90VGJwMElPaTVxcEpxT3dQZDM0V0F3SURjeHppSnFrOUM1TFAtMHpMTGVRUjA1TXJuSXFFYWRVdXNvNks5RmE3SzEtVDE3WUMxVjQ2X1p2aXgzT3UxZ09lOHFDcWNCNm14ZEhaVGZuTVo0OFFPWEJkZ2gxd2NDRFd6c2dld0k4cVY3NkFzT3pMUGloZFhKN01XUVFjWERrMzJnX3dRcWRIOU03OWwzTDZ6cWFfVVlldV9fcy1nS1o5TzlUZWwtYTRENmxVOUdROUExZDl2S3J4ZjlTYm9ER2UxdUNITFhoV1Z2N3BiRE9KWHR0MVJZUV80cl9YTkdWMDBmQnRQUFN4b3BOMmc3LWpIazJiU01EcW5LSmxDaXRTOHRlbERYMmxhRHpCdHlTTTdjWDdja1N2YlRvaHJDSHp6cmowa1ZpODNMSG9pWDl5VFJYcWVTbE1YamRXV2VXa05kV1o4bVg2NTFCQVBiWm1nMmhQYVFmX2tYNTJTcFBtcDQwaU8yQWpjRjBJc0lSRXl6ck1Xd2U5X2xubDBncXdXREhGYko5OWVyQVJkZXVWOGRNLVVITW8tbGRrcFg0bUpodFV2S0t2VjBNUUhaNlFUbms5VFZqVkJ2M2FpMXY5cTVWZjBBbGUxOUhZa0lVTjFCeFRnc1NZbS1aRldpZ0ZlTzN5R3FDd3FVakJWbWY1S2V4enk5cS1DN3hsUTVkUmN2OWF2S1dqSHhjSmlyVGlZenR1QW1WcFJwZ2Rwc2dLeXJfUEFyTVdlZ09OSDEzUjdSUWlzNllWWGhmVnU1VGtoWExva3kxRFpDbFpkcmpoZjlYZVBGSXMxUUk2VUFHbkpBNjBmYy1Sbjg5NXNsaGVULUo1UmlHNmtzZU8ydWtySkVqckFCYW1ERzhEWmxrcVhRZXkydGpRY25NVlljM0t5WU1LNDRNOFVzOGtIWks2d3NfRDZfQ0VHTWp2NUdkUFZkLTd3Zjl0aTlZaTJodko1SmgzeG9nRlZoU096TFVGU0FfbDNWRF9MbG5MSUNBT0VweU5HemJRaVJldVNwd3VSMXkzQ2ROb0JOWUx4OTVNYk5sWEpMMUtCZEdEUnJ3bUUycjVkbVE4cDFHLW9SNEI5bGVueVNMOUJ3YUtpQTdSREtlNEJleEVwbHU3SHREQVZRWFZyTHVEU1lmOENCXzJKMHVHZjRLcUFUQ2RBX3Vmd2Y1STFZN0FFai1UU0NEajkxU2dSZFFzWld0XzczbWxVUmJyUUFfeDMwV3RuUEVvV0F4azQ2Qy00a0ZiQlNnNGFISkZOc1ZrUzZseEVseXJRZE5FbUVBdHk0eXlDSnNyMkszTWFfR1V3QkJiVUVHbW9peFd1cWJVd3F6eTVvYkZUZm4wTU1VZFE1U3NJc1p2bGRDLVg0ekNsTF9rZzd5T05rWXh4cGE0NjBuN1ptWkZXSHRlZXR5YWVVTk5Dd0ExZ1kxdnZwT05fT2lhS2FwLVZINTF5dWtuVlhyTE1YU1lnc0N3dDUwTFRDRWRMYmVILTdWdldDY1FhVmVFdlVxRXNEMnZSZnhWckx4STdkaGJ1dTJxaWowc0tFNzFhYl9aVEVQV2tiaEJoQjdpb2hHbE1neGtOS1dFSjg3US10M0xRMmpMeGdOQ0xlWjNTeGQ3THpydHcxeHJEY2Q5S1ZYX1l2a2t2UTllM190RnBlcDRSZS1BYkc4cmx1aExBWmRSR2dvbklhNGpYUW9QR1hOUVdnMFR0dnlLNTkzZEpOS05GQVNyNVh6ODdPQ3lZT1o4b21aeW1jWW1zMXhXNzBNd2taQmxYSjVfLUs2MGJTeWpQVXpHWURwaS15ajJqQUNQdnh5RDBsdG0tSzNWQWEzRHByUE9oOTlLOXlIdVVmV2ZtcWp5OV9EcmJ1VXE3NlA2YzNqVmE3RFd6QU5QeTY3QUVnRmJyUlQ5TUtJSWlqV1BHVlVVRng5TWd1cFNGNkk2a2NhRy1WOTNPc2o5Y1d0WkZRRV8xYVl1LUZIdnZ3cjZYbnhTUlJVYklZck1SenhZS3F1Z1RHT1B6MHpIT3lXWUZ6OF83WEpvallUWm5POTRtU1lFOUU1bU11a1BQQWNnb21URTIzSnh1SG0tOEg4Smo2b01XNTd3elR0NUE0TDF6ekt2ZkR2RU5JQWlzXy1aR3l6ZHlKeXB1S3QtOXdVQlJjQmEtMzFvdzlQTzRYa1FweXZCMmFwcGQzaTNtX0VNZnJ1a0M2WnF2Qno0VC01Z3doTlRDdW1JbHJQdz0=)
    scripts:
      - name: Set signing
        script: |
          echo $CERTIFICATE | base64 --decode > /tmp/certificate.p12
          keychain initialize
          keychain add-certificates --certificate /tmp/certificate.p12
      - name: Build
        script: |
          flutter config --enable-macos-desktop
          flutter build macos --release --build-number=$BUILD_NUMBER
      - name: Notarize
        script: |
          set -ex
          cd build/macos/Build/Products/Release
          APP_NAME=$(find . -name "*.app")

          ditto -c -k --keepParent "$APP_NAME" "application.zip"                         # altool can only accept an archive, disk image or package
          REQUEST_UUID=$(
            xcrun altool --notarize-app -t osx -f application.zip --primary-bundle-id io.codemagic.macosDesktop -u $APPLE_ID -p $APP_SPECIFIC_PASSWORD --output-format json | \
            jq '."notarization-upload".RequestUUID' | xargs)
          REQUEST_STATUS=$(xcrun altool --notarization-info $REQUEST_UUID -u $APPLE_ID -p $APP_SPECIFIC_PASSWORD --output-format json | jq '."notarization-info".Status' | xargs)
          while [ "$REQUEST_STATUS" == "in progress" ]; do
            sleep 120
            REQUEST_STATUS=$(xcrun altool --notarization-info $REQUEST_UUID -u $APPLE_ID -p $APP_SPECIFIC_PASSWORD --output-format json | jq '."notarization-info".Status' | xargs)
          done

          if [ "$REQUEST_STATUS" == "success" ]; then
            ditto -xk application.zip . && rm -rf application.zip
            xcrun stapler staple "$APP_NAME"
            spctl -a -vvvv "$APP_NAME"                                                   # ensure that the application is signed
            ditto -c -k --keepParent "$APP_NAME" "application.zip"                       # need to archive it with ditto otherwise codemagic's zip archive will brake the signature
          fi
    artifacts:
      - build/macos/Build/Products/Release/*.zip