workflows:
  notarize_get_cert:
    name: notarize get certificate
    instance_type: mac_pro
    environment:
      vars:
        CERTIFICATE_PRIVATE_KEY: Encrypted(Z0FBQUFBQmdiOXBBdlNmRC1wT0JjNm5JbWtwcnlCTHRuTW91WXpFbFBvUVNYUEk0VnlCdW05emhRQXJvNGRnM0NMazlDTm1Sd2hYYjBEamg2MzJGMWg4clNDWnAzQjVrNW4tb2dESkw0eTFoVktUUHFEZWFhcFJhQ04tQ3R2dU80UlVVa0tFVzlxVkNielR6U2txY2hoaDhoSDZXV0ViZVR4Z2t2RFZWSUlTa0hIMDhxMUgtSFh0TWYxT0tyNVVyWnpLWjFaR180Y1ZIRGxwS1VkNnB5YmxSanM1Mnc3QURob3E1MEt4emJKMDZFYVJnVkxxTThMNGdqcUhtQWtGcmRnS2xXYk9xRTk2Y0hjS0ktdXZ6SXJPT3ktWjRVdVh0d3RxQlpXamplTzU1QUt4V3o4U251ZVhBbnFBN0U1MkJyZ0E3djhCS3lnZjF0bVp6ZERkTmkyQjJuUWwtYVFjNFRjVjh4cUp2MG5NWWxNaUFXRFhXZnRQTG5pczc1NkVBWFRWNmlWY3ltZ1pXdENsN1NzaHpaWUE0YXpLVDlBNTQ1OGFaa3FaQVBGM1pPWkhEWE1fd0MyaEIwbHBXSUN6Sm5xUFBPTWptal95ZnF2UWhEb3QwSDNnV2NUMWpKSlJEUmxrMmprZFhmNEFoRURVa1l2dHF3cVppVklkR25iQ1U3RUg3bjBGMzgtbENueXR6T3oybjFTcm9JaGxsQ0R4NFRnRlJMZjZGdHpEUE1odUhmVTlCQnpYOEVTbHpsY3h4U3ZhenlIZmg4MVVLOHdLTFYyR3lJZzlhWU1QVDJ5U291R0pkbW5sYnp1U19iaENTby1FSmtkNHpCd0p2aGJJcG1OeUxrQ0RGd2gwT0FicjE1TVNoVnFvdTlrZHdFc19IbWJEYjlaQ0tjSmVMT2NBdzZGX1VEVTdlLW1LNzlZelc1d3lWRHpMMDlCV2QtbkpYZ3lBbmJqSjdVYnNDRnhDNVNVSVZpelg3bk5xREI3S0hLVXZrY0VJMk9KVW1BQ1Z2bVVHM0toNzNDRlUyYlkwV3R6ZHdBLUlMeXZYY0tFSExfZFVDSXVOLWljN2s2TGtTellZZW90Nk5JYUxLTm5LMVNfcTBtZWttT2N2eWFwZEtJaUpZZ1hhUHI3Vlo0anRFd1FyZnZVX0VWdXRkdHJMbjRvQUNMTldKX2N5dlA4THlWRGZRd3lPdzZqNktsdEVNMlBHUi1Sc2Vfd3hPV1V1VWQ2cGp1c1hWVzJGSDQ1aDY2UEJ4Wm5ic3gxdWhXRFM5dk15b3NweFJpUTRxaXhGRlBLaHZkMnR0N0c4dGpEOXZaSmdrUF9JTlBqWDZFRHVvQ2xKZkZoNml6Z2ptenNjTzlrVERNNTRYUGUyQ3dQVEZkcVpOXzFVUW1ZQTBvZC1vbmtrRVUxOXlKU051bi1lWHA2NUZzU0d1ZVo1bUlmSFFZX1lzOFpZTHVZblZYOVA3VU1NdERIMC1UeTB2UGNKWVVRMFJhMUprMUVGT1RSUXJCNG11NWJkVU1NaHJ0aW9ZdENQNERLTFFuLWxjYlpUaXNuOFl3V0c5bnh6d2JhUkxwX2ItWFVya0Z1SDdpS05wcVpHWW9kSEk5aXRKNEowaUQzbXp4d3F3d2NDUjJxR0JfU28tX3h6UmN2MHB3S0hfV2JLakJFTGZfd0VZQlptSGtBNHFiNzNTdVhWcWhxb01idG56VlNaOGtrVGV6VmxXSlAwODlqTm90RzV6UkkzYS1PYW41NEs0cWVqMWd3TFdyMWlzXzF6bEdjMjJ4YmlubjlfT3JNUHZDR3RYQjlVYzZpcVBQdVFyb0JSeV9FcXNoRHdScXNoVE5sb1d6emprYmx3QjBQc0d4Q2tEM3k2Tk1tOXpRT0p6TUZUYWhYZmhIcjg4ZkxXXzRzb202MjhYZ3VReGhzaE81SVgyVXhCTmhkc2lVTlN6XzQ1RnVVdkdQclZUODRzQjdlLVRsdjRLYjBDYUFudWVXdlZ0SUdBR1piY2RackJaLWx2dlpUQS1Dc29JOENNWHdWdzdFT21nLWpVd3JmRkVmWEY3S3JfQkxkQV9OTU81VndUR2FSS3ZBdVFaSnBiQ3hhQ05yZWZhWTRDdmR1dlJSTTR6dHRGSW5qNWZ1RWw2alNJSEZEWE1aWFJDTkJqZlNEbk9mampYb0Z5TW5QQUZxZHY5NG1xR0RMTVJXaE9NNTAtSm12T0V5VW41dVNLajRtY1g4SUVsWThEZlBoalgtRXBHbUhGajJaOFFsZV9pbmFHWGkyVVNZTzNpRFRrM1A0RTBtUnJ3dzRXcG9pLTFXdlhHZVllUmpwek55TTBoUGl0N1RvQUxyQVhIRXRZcWJmRG5VQ3VTNGZIUnB6TTNGellHN2tjN2RDUkhBTWduUHRMWWlNX2M4aktqaW13Qk1iQ0lIQml5VmdFbS1BdXdPZmJRY18ySUhPR1BGMGFXbUZJZGlmOWtweDJLTUctd0FIemd2SDFxSlZ3TWtwZ2RXQTh3UFUwVk42alVUQ1J0VUVKdTlfNlJyR2llOXZUN3RjNjRDdTBsMENxTUNJd2p2NXd1WDhzOXJ2ajNzem9UeUtiZXBYejhKbFRZSGNzN21zcHRaNm53VGN5NXVGbDVZc3dpdFZrVDRLUi1zOHNlVzdFWnBtVG9XZWREMGhSUVFPU1Q0NmxBMEtNeDFXTkxpdXBBMmw0ODVKU1VMQmNUMkk4RHBOWDdRVDJrZ0RSaE1pRHJ2Vno5UjJUX2Y3a1ZGQzBKQkNIakd3VXRaeXYyNVgzTjUxc05tcEc2YlJsU1JVaVh2TWNoX3k5b0lObGVMU2ktb00yaU1mdEkyQ01nbTBJVF9vOFV2WWl1Z011dGtSYWFoWHN0WXZEdG95MlZyc0s5ZWpCd1J5QWhwWUZFVTdzTmp4cTZWY0UyTndVWEQzZEpLXzc5aFZYUmY1RWxuemloOEFsbDMyYk1jcUFvbC12b0NVclpJVTZ0X2JjU3AtRk5TVmJrczNzeDlMTTFyNFg0a251WU03UTc0TDFIRTl2YVhmQ0RmOFJNRk5fM3JERzQxTzZDYjY3eDJXdW0tTzNr)
        APP_STORE_CONNECT_KEY_IDENTIFIER: Encrypted(Z0FBQUFBQmdic05WMlNkXzFkUWFySmJIOW9CdkprSVNGZ3JrUTVTcnpYUzZ0TTBVa2U0TzdMcndGNHFIOC1ZUFZFWldWTjJ2Q1NpTl82WjBCMU1nLXRxSTh1NTRSNkxwNmc9PQ==)
        APP_STORE_CONNECT_ISSUER_ID: Encrypted(Z0FBQUFBQmdic05IWl9YWXdXQmxrRXc4ckViaWNrWWpnaEdHYmRCUWRDc1hWdmdHMWk2WjdWOHBRSlo1LWRBLUN4R3k5aU9QM1ZPdTVMVDNWc3JHVVJ0MTUxQTdBbHYyTnNId0tMY2VkZWZGY0paWEE0TlJCRGNUaU5GMkt6WW1OSHRoM3pTWmdUU0k=)
        APP_STORE_CONNECT_PRIVATE_KEY: Encrypted(Z0FBQUFBQmdic016b3VKc2NJRkxwTnloM3dNSFdVam4xTzRUY2F1R250d3kyTzJtendGa0I2Ti0wZ1RTb0JKb2QwdUhzQzdfcG9oblYxMDJaNmFTdDBsc2lPREtFSzQyZDFKOFc1VU9JakY2OFg2eWxkd0tBSjVaQlA3SU4tVkJ6Q1hKV3Q0SmYyY0QxOWhkS3g0RXU1UFlGUThGUnd6VEhOTUJKd1lRcS1rTmZrVWc2SU1WeTNHMGV1dUN4M1k0SFlfVVVfWXlwaW9yNmdFMldJdW1aSmdFa3ByaDBndWhTcERka1g3am9pVWNEaUd2N1duN2gtRDZYUEhNbmwwWmVuSVhja3dEWDJGOVFPeVRfWTlKN21iSUVpeGgtdWpWZGdYRDU5Q2xqR2M1YlU1TTVTZG9RN05paE5kd1NEc01KeUtPcTBFSS1OUjQ3cVQwY1E3QW10ZE12VkhPbFd1M1h6WS0zUEhEeU0teTRERFU2b2ZOeUN0YWRBdDVjczRmZUsyN2hMNXlqVDRZaWNGSnZEaUgweHJTTFR6b3EyemtQd0ttR3lpN1ZCREx5NmhjZDI2Sl9zQT0=)
        APP_SPECIFIC_PASSWORD: Encrypted(Z0FBQUFBQmdiZkd2NVRjOHR2SHN6eWUzQldrTlNyTFFJeFdSQ0o3Z21vSmI5ZWM2cWFHTG9MakNLNEhuMm04NXJxUlFVS0NvRUtyblFON0xUWnJDM1RwZkFGMzZ3eVdpSXhsUURxb3gyYnl0N19odkRMSEM5Y1U9)
        APPLE_ID: Encrypted(Z0FBQUFBQmdic04tQl9QbXVNbEU3VWI1NnE1V3ZuWDJuM2FfRng3Q0FpQS1yQi1qeERLZ2VOVEd4bllIYm5OLXZBV1lVbzZmUDBjOWUyMy0tc2hkcWF5STdXM1JkZGlNcDBiMXVTRWZoNnNKMDBHNDFXRDRNRmM9)
    scripts:
      - name: Set signing
        script: |
          keychain initialize
          app-store-connect list-certificates --type DEVELOPER_ID_APPLICATION --save
          keychain add-certificates
      - name: Build
        script: |
          flutter config --enable-macos-desktop
          flutter build macos --release --build-number=$BUILD_NUMBER
      - name: Notarize
        script: |
          set -ex
          cd build/macos/Build/Products/Release
          APP_NAME=$(find . -name "*.app")
          ditto -c -k --keepParent "$APP_NAME" "application.zip"
          REQUEST_UUID=$(
            xcrun altool --notarize-app -t osx -f application.zip --primary-bundle-id io.codemagic.macosDesktop -u $APPLE_ID -p $APP_SPECIFIC_PASSWORD --output-format json | \
            jq '."notarization-upload".RequestUUID' | xargs)
          REQUEST_STATUS=$(xcrun altool --notarization-info $REQUEST_UUID -u $APPLE_ID -p $APP_SPECIFIC_PASSWORD --output-format json | jq '."notarization-info".Status' | xargs)
          while [ "$REQUEST_STATUS" == "in progress" ]; do
            sleep 120
            REQUEST_STATUS=$(xcrun altool --notarization-info $REQUEST_UUID -u $APPLE_ID -p $APP_SPECIFIC_PASSWORD --output-format json | jq '."notarization-info".Status' | xargs)
          done
          ditto -xk application.zip . && rm -rf application.zip
          if [ "$REQUEST_STATUS" == "success" ]; then
            xcrun stapler staple "$APP_NAME"
            spctl -a -vvvv "$APP_NAME"
          fi
    artifacts:
      - build/macos/Build/Products/Release/*.app